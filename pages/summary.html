<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Winter Classic â€“ Player Summary</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tablesort/5.2.1/tablesort.min.js"></script>
<style>
    body { background-color: #f7f7f7; padding: 20px; }
    table { background: white; }
    .modal-content { border-radius: 10px; }
    .player-link { cursor: pointer; color: #0d6efd; font-weight: 600; }
    .player-link:hover { text-decoration: underline; }
</style>
</head>

<body>
<h1>Player Summary</h1>

<div class="table-responsive">
<table id="summaryTable" class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>Player</th>
            <th>Total Matches</th>
            <th>Total Winnings</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>
</div>

<div class="modal fade" id="playerModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="playerModalLabel">Player Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <table class="table table-sm table-striped">
          <thead>
            <tr>
              <th>Page</th>
              <th>Match #</th>
              <th>Result</th>
              <th>Winnings</th>
            </tr>
          </thead>
          <tbody id="modalTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
let playerData = {};

function loadCSV() {
    Papa.parse("../assets/player_match_results.csv", {

        download: true,
        header: true,
        complete: function(results) {
            processData(results.data);
        }
    });
}

function processData(data) {
    playerData = {};

    data.forEach(row => {
        const player = row.player;
        if (!player) return;

        if (!playerData[player]) {
            playerData[player] = { matches: 0, totalMoney: 0, details: [] };
        }

        playerData[player].matches++;

        let money = 0;
        if (row.Winnings && row.Winnings.trim().startsWith("$")) {
            money = parseFloat(row.Winnings.replace("$", "").trim());
            playerData[player].totalMoney += money;
        }

        let result = "Played";
        if (row.Winner && row.Winner === player) result = "Winner";
        if (row.Loser && row.Loser === player) result = "Loser";

        playerData[player].details.push({
            page: row.page,
            match: row.match,
            result: result,
            winnings: row.Winnings
        });
    });

    buildTable();
}

function buildTable() {
    const tbody = document.querySelector("#summaryTable tbody");
    tbody.innerHTML = "";

    Object.keys(playerData).sort().forEach(player => {
        const p = playerData[player];

        const row = document.createElement("tr");
        row.innerHTML = `
            <td><span class="player-link" onclick="openModal('${player}')">${player}</span></td>
            <td>${p.matches}</td>
            <td>$${p.totalMoney}</td>
        `;
        tbody.appendChild(row);
    });

    new Tablesort(document.getElementById("summaryTable"));
}

function openModal(player) {
    const modalLabel = document.getElementById("playerModalLabel");
    const modalBody = document.getElementById("modalTableBody");

    modalLabel.textContent = player;
    modalBody.innerHTML = "";

    playerData[player].details.forEach(d => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${d.page}</td>
            <td>${d.match}</td>
            <td>${d.result}</td>
            <td>${d.winnings}</td>
        `;
        modalBody.appendChild(row);
    });

    const modal = new bootstrap.Modal(document.getElementById('playerModal'));
    modal.show();
}

loadCSV();
</script>
</body>
</html>
