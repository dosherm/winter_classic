<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=2">
  <title>Golf Summary</title>
  <link rel="manifest" href="/winter_classic/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/winter_classic/assets/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#2a78c8">
  <link rel="stylesheet" href="/winter_classic/assets/styles.css">

  <!-- Bootstrap (for modal and table styling) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

  <!-- Tablesort -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tablesort/5.2.1/tablesort.min.js"></script>

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => navigator.serviceWorker.register("/winter_classic/service-worker.js"));
    }
  </script>

  <style>
    /* small tweaks on top of your existing styles.css */
    .summary-table-container {
      margin-top: 20px;
    }
    .player-link {
      cursor: pointer;
      color: #2a78c8;
      font-weight: 600;
    }
    .player-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>

<header class="header" style="display:flex;align-items:center;gap:10px;padding:12px 16px;background:linear-gradient(135deg,#2a78c8,#1f5ea0);color:#fff;">
  <a class="back" href="/winter_classic/pages/golf.html" style="color:white;text-decoration:none;font-size:18px;">‹ Back</a>
  <img src="/winter_classic/assets/SVG/WWC_logo.svg" alt="WWC Logo" style="height:40px">
  <h1 style="margin:0;font-size:18px;line-height:1;">Golf Summary</h1>
</header>

<main class="container">
  <div class="section">
    <h2>Player Winnings Summary</h2>
    <p>Tap a player name to see their match results.</p>

    <div class="summary-table-container">
      <div class="table-responsive">
        <table id="summaryTable" class="table table-striped table-bordered">
          <thead>
            <tr>
              <th>Player</th>
              <th>Total Matches</th>
              <th data-sort-method="currency">Total Winnings</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</main>

<div class="footer">Built for offline use • Winter Classic</div>

<!-- Modal -->
<div class="modal fade" id="playerModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="playerModalLabel">Player Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <table class="table table-sm table-striped">
          <thead>
            <tr>
              <th>Page</th>
              <th>Result</th>
              <th>Winnings</th>
            </tr>
          </thead>
          <tbody id="modalTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- JS libs -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
// Extend Tablesort to handle currency as numeric
Tablesort.extend('currency', function(item) {
  // detect: cell that starts with $, £, €, or contains digits with $ somewhere
  return /^[\s]*[$£€]/.test(item) || /^[\s]*[$£€]?\s*\d/.test(item);
}, function(a, b) {
  var numA = parseFloat(a.replace(/[^0-9.\-]/g, '')) || 0;
  var numB = parseFloat(b.replace(/[^0-9.\-]/g, '')) || 0;
  return numA - numB;
});

let playerData = {};

function loadCSV() {
  Papa.parse("/winter_classic/assets/player_match_results.csv", {
    download: true,
    header: true,
    complete: function(results) {
      processData(results.data);
    }
  });
}

function processData(data) {
  playerData = {};

  data.forEach(row => {
    const player = row.player;
    if (!player) return;

    if (!playerData[player]) {
      playerData[player] = {
        matches: 0,
        totalMoney: 0,
        details: []
      };
    }

    playerData[player].matches++;

    // Normalize Winner/Loser flags (case-insensitive, trimmed)
    const winFlag  = ((row.Winner || "").trim().toUpperCase() === "X");
    const lossFlag = ((row.Loser  || "").trim().toUpperCase() === "X");

    let result = "N/A";
    if (winFlag)      result = "Win";
    else if (lossFlag) result = "Loss";

    // Only add winnings when this player is a winner
    let money = 0;
    if (winFlag && row.Winnings && row.Winnings.toString().trim().length > 0) {
      const stripped = row.Winnings.toString().replace(/[^0-9.\-]/g, "");
      if (stripped) {
        money = parseFloat(stripped) || 0;
        playerData[player].totalMoney += money;
      }
    }

    playerData[player].details.push({
      page: row.page,
      result: result,
      winnings: row.Winnings || ""
    });
  });

  buildTable();
}

function buildTable() {
  const tbody = document.querySelector("#summaryTable tbody");
  tbody.innerHTML = "";

  Object.keys(playerData).sort().forEach(player => {
    const p = playerData[player];
    const row = document.createElement("tr");

    // data-sort attribute for numeric sorting if needed
    row.innerHTML = `
      <td><span class="player-link" onclick="openModal('${player.replace(/'/g, "\\'")}')">${player}</span></td>
      <td data-sort="${p.matches}">${p.matches}</td>
      <td data-sort="${p.totalMoney}">$${p.totalMoney}</td>
    `;
    tbody.appendChild(row);
  });

  new Tablesort(document.getElementById("summaryTable"));
}

function openModal(player) {
  const modalLabel = document.getElementById("playerModalLabel");
  const modalBody = document.getElementById("modalTableBody");

  modalLabel.textContent = player;
  modalBody.innerHTML = "";

  playerData[player].details.forEach(d => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${d.page}</td>
      <td>${d.result}</td>
      <td>${d.winnings}</td>
    `;
    modalBody.appendChild(row);
  });

  const modal = new bootstrap.Modal(document.getElementById('playerModal'));
  modal.show();
}

loadCSV();
</script>

</body>
</html>
